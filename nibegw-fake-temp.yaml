esphome:
  name: nibegw
  friendly_name: nibegw

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "mscyRrmJhRNSFVVIfCCeug5pX5ZP80/IfPPjsGuW9K8="

ota:
  password: "6d7782bf8dde5c2a5a45d808a82a3e4a"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Nibegw Fallback Hotspot"
    password: "FHFW89N6SHdb"

captive_portal:

# Load nibe component
external_components:
  # - source: github://elupus/esphome-nibe
  - source: components

uart:
  rx_pin: GPIO16
  tx_pin: GPIO17
  baud_rate: 9600

# modbus:
#   # id: modbus_brink
#   send_wait_time: 200ms

# modbus_controller:
#   - id: nibe
#     ## Brink Modbus slaveaddress 20
#     address: 1 
#     command_throttle: 200ms
#     setup_priority: -10
#     update_interval: 10s

# Configure NibeGW
nibegw:
  udp:
    # The target address(s) to send data to. May be a multicast address.
    target:
      - ip: 192.168.8.147
        port: 10090

    # List of source address to accept data from, may be empty for no filter
    source:
      - 192.168.8.147

  rmu40_fake_temp_sensor_id: rmu40_fake_temp

  acknowledge:
    - MODBUS40

    # Enable a dummy RMU40 accessory to receive updates
    # to certain registers faster. This should not be
    # enabled if you have an actual RMU40.
    - RMU40_S1

  # Constant replies to certain requests can be made
  constants:
    - address: MODBUS40
      token: ACCESSORY
      data: [
            0x0A, # MODBUS version low
            0x00, # MODBUS version high
            0x02, # MODBUS address?
      ]

    # Accessory version response
    - address: RMU40_S1
      token: ACCESSORY
      data: [
            0xEE, # RMU ?
            0x03, # RMU version low
            0x01, # RMU version high
      ]

    # Unknown response that nibepi uses
    - address: RMU40_S1
      token: RMU_DATA
      command: RMU_WRITE
      data: [
            0x63,
            0x00,
      ]

    # Constant fixed temperature to avoid pump going into alarm.
    # - address: RMU40_S1
    #   token: RMU_WRITE
    #   data: [
    #         0x06, # Temperature
    #         0xC8, # degrees low
    #         0x00, # degrees high
    #   ]

# Some helper functions to restart ESPHome from HA
button:
  - platform: restart
    name: Nibegw Restart
  - platform: safe_mode
    name: Nibegw Safe Mode Boot

number:
  - id: rmu40_fake_temp
    name: RMU40 Fake Temperature
    platform: template
    unit_of_measurement: "Â°C"    
    min_value: 0
    max_value: 50
    step: 0.5
    initial_value: 20
    icon: mdi:home-thermometer
    set_action:
      then:
        - lambda: |-
            id(rmu40_fake_temp).publish_state(x);
